@page "/documents/{Collection}"
@inject StudioService Studio

<div class="breadcrumb">
    <a href="@CollectionsUrl" class="breadcrumb-link">üóÇÔ∏è Collections</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    <a href="@ManageUrl" class="breadcrumb-link mono">@Uri.UnescapeDataString(Collection)</a>
    @if (!string.IsNullOrEmpty(DatabaseId))
    {
        <span class="breadcrumb-db">(@DatabaseId)</span>
    }
    <span class="breadcrumb-sep">‚Ä∫</span>
    <span>Documents</span>
</div>
<h1>Documents</h1>

@if (!string.IsNullOrEmpty(_message))
{
    <div class="alert @(_isError ? "alert-error" : "alert-ok")">@_message</div>
}

<div class="doc-browser">

    <div class="doc-table-pane">
        <div class="toolbar">
            <span class="toolbar-label">Showing @_rows.Count of @_totalCount documents</span>
            <button class="btn btn-small" disabled="@(_page <= 0)" @onclick="PrevPage">‚óÄ Prev</button>
            <span class="toolbar-label">Page @(_page + 1)</span>
            <button class="btn btn-small" disabled="@(!_hasNext)" @onclick="NextPage">Next ‚ñ∂</button>
        </div>

        @if (_rows.Count > 0)
        {
            <div class="table-scroll">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>_id</th>
                            @foreach (var col in _columns)
                            {
                                <th>@col</th>
                            }
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in _rows)
                        {
                            var isSelected = _editId is not null && _editId.Equals(row.Id);
                            <tr class="@(isSelected ? "row-selected" : "")">
                                <td class="mono">@FormatId(row.Id)</td>
                                @foreach (var col in _columns)
                                {
                                    <td>@(row.Fields.GetValueOrDefault(col, ""))</td>
                                }
                                <td>
                                    <button class="btn btn-small @(isSelected ? "btn-active" : "")"
                                            @onclick="() => OpenEditor(row.Id)">
                                        @(isSelected ? "‚ñ∂ Open" : "Open")
                                    </button>
                                    <button class="btn btn-small btn-danger"
                                            @onclick="() => Delete(row.Id)">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <p class="empty">No documents in this collection.</p>
        }
    </div>

    @if (_editId is not null)
    {
        <div class="doc-editor-pane">
            <div class="doc-editor-header">
                <span class="mono doc-editor-id" title="@FormatId(_editId)">@FormatId(_editId)</span>
                <button class="btn btn-small" @onclick="CloseEditor" title="Close panel">‚úï</button>
            </div>
            @if (_loadingJson)
            {
                <p class="loading" style="padding:16px">Loading‚Ä¶</p>
            }
            else
            {
                <textarea class="json-editor doc-json-textarea"
                          @bind="_editJson" @bind:event="oninput"
                          spellcheck="false"></textarea>
                <div class="doc-editor-footer">
                    @if (!string.IsNullOrEmpty(_editorMessage))
                    {
                        <span class="doc-editor-msg @(_editorError ? "text-red" : "text-green")">
                            @_editorMessage
                        </span>
                    }
                    <button class="btn btn-primary btn-small" @onclick="SaveDocument"
                            disabled="@_saving">
                        @(_saving ? "Saving‚Ä¶" : "üíæ Save")
                    </button>
                </div>
            }
        </div>
    }

</div>


@code {
    [Parameter, SupplyParameterFromQuery(Name = "db")] public string? DatabaseId { get; set; }
    [Parameter] public string Collection { get; set; } = "";

    private const int PageSize = 50;

    private List<DocumentRow> _rows    = [];
    private List<string>      _columns = [];
    private int  _totalCount;
    private int  _page;
    private bool _hasNext;
    private string _message = "";
    private bool   _isError;

    // JSON editor panel
    private BLite.Bson.BsonId? _editId;
    private string _editJson       = "";
    private string _editorMessage  = "";
    private bool   _editorError;
    private bool   _loadingJson;
    private bool   _saving;

    protected override async Task OnParametersSetAsync() => await LoadPage();

    private async Task LoadPage()
    {
        try
        {
            var col = Uri.UnescapeDataString(Collection);

            _totalCount = await Studio.CountDocumentsAsync(DbId, col);
            _rows       = await Studio.GetDocumentsAsync(DbId, col, _page * PageSize, PageSize);
            _hasNext    = (_page + 1) * PageSize < _totalCount;

            _columns = _rows
                .SelectMany(r => r.Fields.Keys)
                .Distinct()
                .OrderBy(k => k)
                .ToList();

            _isError = false;
        }
        catch (Exception ex)
        {
            _message = ex.Message;
            _isError = true;
        }
    }

    private async Task OpenEditor(BLite.Bson.BsonId id)
    {
        if (_editId is not null && _editId.Equals(id)) { CloseEditor(); return; }

        _editId        = id;
        _editorMessage = "";
        _editorError   = false;
        _loadingJson   = true;

        try
        {
            _editJson = await Studio.GetDocumentAsJsonAsync(DbId, Uri.UnescapeDataString(Collection), id);
        }
        catch (Exception ex) { _editorMessage = ex.Message; _editorError = true; }
        finally  { _loadingJson = false; }
    }

    private void CloseEditor()
    {
        _editId        = null;
        _editJson      = "";
        _editorMessage = "";
    }

    private async Task SaveDocument()
    {
        if (_editId is null) return;
        _saving = true;
        _editorMessage = "";
        try
        {
            var ok = await Studio.UpdateDocumentFromJsonAsync(
                DbId, Uri.UnescapeDataString(Collection), _editId!.Value, _editJson);
            _editorMessage = ok ? "Saved." : "Document not found.";
            _editorError   = !ok;
            if (ok) await LoadPage();
        }
        catch (Exception ex) { _editorMessage = ex.Message; _editorError = true; }
        finally { _saving = false; }
    }

    private async Task PrevPage() { _page = Math.Max(0, _page - 1); await LoadPage(); }
    private async Task NextPage() { _page++; await LoadPage(); }

    private async Task Delete(BLite.Bson.BsonId id)
    {
        try
        {
            await Studio.DeleteDocumentAsync(DbId, Uri.UnescapeDataString(Collection), id);
            _message = "Document deleted.";
            _isError = false;
            if (_editId is not null && _editId.Equals(id)) CloseEditor();
            await LoadPage();
        }
        catch (Exception ex) { _message = ex.Message; _isError = true; }
    }

    private string? DbId =>
        string.IsNullOrEmpty(DatabaseId) ? null : Uri.UnescapeDataString(DatabaseId);

    private string CollectionsUrl =>
        string.IsNullOrEmpty(DatabaseId)
            ? "/collections"
            : $"/collections/{Uri.EscapeDataString(DatabaseId)}";

    private string ManageUrl
    {
        get
        {
            var col = Collection; // already URL-encoded as route param
            return string.IsNullOrEmpty(DatabaseId)
                ? $"/collection/{col}"
                : $"/collection/{col}?db={Uri.EscapeDataString(DatabaseId)}";
        }
}

    private static string FormatId(BLite.Bson.BsonId? id) => id?.ToString() ?? "?";
}
