@page "/"
@inject StudioService Studio
@inject IJSRuntime JS

<h1>ðŸ“Š Dashboard</h1>

@if (_info is null)
{
    <p class="loading">Loadingâ€¦</p>
}
else
{
    <div class="card-grid">
        <div class="card">
            <div class="card-label">Engine Version</div>
            <div class="card-value">@_info.Version</div>
        </div>
        <div class="card">
            <div class="card-label">Uptime</div>
            <div class="card-value">@FormatUptime(_info.Uptime)</div>
        </div>
        <div class="card">
            <div class="card-label">Tenants</div>
            <div class="card-value">@_info.TenantCount</div>
        </div>
        <div class="card">
            <div class="card-label">Users</div>
            <div class="card-value">@_info.UserCount</div>
        </div>
        <div class="card full-width">
            <div class="card-label">Databases Directory</div>
            <div class="card-value mono">@_info.DatabasesDir</div>
        </div>
        <div class="card full-width card-source">
            <div class="card-label">Source Code (AGPL-3.0 Â§13)</div>
            <div class="card-value">
                <a href="@_info.SourceUrl" target="_blank" rel="noopener noreferrer" class="source-link">
                    @_info.SourceUrl
                </a>
            </div>
        </div>
        <div class="card full-width">
            <div class="card-label">System Database Backup</div>
            <div class="card-value">
                <button class="btn btn-small" @onclick="BackupSystem" disabled="@_backupRunning">
                    @(_backupRunning ? "Creating backupâ€¦" : "â¬‡ Download Backup (system)")
                </button>
                @if (!string.IsNullOrEmpty(_backupMessage))
                {
                    <span class="@(_backupError ? "alert alert-error" : "alert alert-ok")" style="margin-left:12px">@_backupMessage</span>
                }
            </div>
        </div>
    </div>
}

@code {
    private ServerInfo? _info;
    private bool   _backupRunning;
    private string _backupMessage = "";
    private bool   _backupError;

    protected override void OnInitialized()
    {
        _info = Studio.GetServerInfo();
    }

    private async Task BackupSystem()
    {
        _backupRunning = true;
        _backupMessage = "";
        try
        {
            var (data, fileName) = await Studio.GetBackupAsync(null);
            await JS.InvokeVoidAsync("studioDownload.saveAs", fileName, "application/zip",
                Convert.ToBase64String(data));
            _backupMessage = "Backup downloaded.";
            _backupError   = false;
        }
        catch (Exception ex)
        {
            _backupMessage = ex.Message;
            _backupError   = true;
        }
        finally
        {
            _backupRunning = false;
        }
    }

    private static string FormatUptime(TimeSpan ts)
    {
        if (ts.TotalDays >= 1) return $"{(int)ts.TotalDays}d {ts.Hours}h {ts.Minutes}m";
        if (ts.TotalHours >= 1) return $"{(int)ts.TotalHours}h {ts.Minutes}m";
        return $"{(int)ts.TotalMinutes}m {ts.Seconds}s";
    }
}
