@inherits LayoutComponentBase
@inject StudioService Studio
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Components.Authorization

@if (Studio.IsSetupComplete && _isAuthenticated)
{
<div class="studio-root">
    <nav class="studio-sidebar">
        <div class="studio-brand">
            <span class="brand-icon">â¬¡</span> BLite Studio
        </div>
        <StudioNavMenu />
        <div class="sidebar-footer">
            <a href="/scalar/v1" target="_blank" rel="noopener noreferrer"
               class="source-badge" title="Interactive REST API (Scalar UI)">
                âš¡ REST API
            </a>
            <a href="/openapi/v1.json" target="_blank" rel="noopener noreferrer"
               class="source-badge" title="OpenAPI spec (JSON)">
                ðŸ“„ OpenAPI
            </a>
            <a href="@Studio.GetSourceUrl()" target="_blank" rel="noopener noreferrer"
               class="source-badge" title="Source code â€” AGPL-3.0 Â§13">
                ðŸ”“ Source Code
            </a>
            <hr class="sidebar-divider" />
            <button class="source-badge" title="Sign out of Studio" @onclick="Logout">
                ðŸšª Sign out (@_username)
            </button>
        </div>
    </nav>
    <main class="studio-main">
        @Body
    </main>
</div>
}

@code {
    private bool    _isAuthenticated;
    private string? _username;

    protected override async Task OnInitializedAsync()
    {
        if (!Studio.IsSetupComplete)
        {
            Nav.NavigateTo("/setup");
            return;
        }
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        _isAuthenticated = state.User.Identity?.IsAuthenticated == true;
        _username        = state.User.Identity?.Name;
        if (!_isAuthenticated)
            Nav.NavigateTo("/login");
    }

    private void Logout() => Nav.NavigateTo("/studio/logout", forceLoad: true);
}
