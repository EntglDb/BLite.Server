syntax = "proto3";

package blite.v1;

option csharp_namespace = "BLite.Proto.V1";

// ─── DynamicService ───────────────────────────────────────────────────────────
// Schema-less path: all documents travel as raw BSON bytes.
// Use this service when compile-time types are unavailable (scripting, migrations,
// server-side processing, cross-language clients).

service DynamicService {
  // Single-document writes
  rpc Insert      (InsertRequest)       returns (InsertResponse);
  rpc Update      (UpdateRequest)       returns (MutationResponse);
  rpc Delete      (DeleteRequest)       returns (MutationResponse);

  // Single-document read
  rpc FindById    (FindByIdRequest)     returns (DocumentResponse);

  // Streaming query — server streams matching documents back one by one.
  // query_descriptor carries the QueryDescriptor (MessagePack-encoded).
  rpc Query       (QueryRequest)        returns (stream DocumentResponse);

  // Bulk operations (single WAL transaction per call)
  rpc InsertBulk  (BulkInsertRequest)   returns (BulkInsertResponse);
  rpc UpdateBulk  (BulkUpdateRequest)   returns (BulkMutationResponse);
  rpc DeleteBulk  (BulkDeleteRequest)   returns (BulkMutationResponse);

  // Collection management
  rpc ListCollections  (Empty)                    returns (CollectionListResponse);
  rpc DropCollection   (DropCollectionRequest)    returns (MutationResponse);
}

// ─── DocumentService ─────────────────────────────────────────────────────────
// Typed path: client sends a QueryDescriptor that encodes the SELECT projection
// and optional WHERE predicate.  The server executes a push-down BSON scan
// (T is never instantiated server-side) and streams raw projected bytes back.

service DocumentService {
  // Streaming typed query
  rpc Query       (QueryRequest)          returns (stream TypedDocumentResponse);

  // Write operations — payload is serialized T (BSON bytes produced by BLite mappers)
  rpc Insert      (TypedInsertRequest)    returns (InsertResponse);
  rpc Update      (TypedUpdateRequest)    returns (MutationResponse);
  rpc Delete      (DeleteRequest)         returns (MutationResponse);

  // Bulk typed writes
  rpc InsertBulk  (TypedBulkInsertRequest) returns (BulkInsertResponse);
}

// ─── Shared messages ─────────────────────────────────────────────────────────

message Empty {}

// Opaque document identifier.  Sent as raw bytes so that ObjectId, string,
// int32, int64, and Guid IDs are all handled uniformly.
message BsonIdBytes {
  bytes  value    = 1;
  int32  id_type  = 2;  // maps to BLite.Bson.BsonIdType enum
}

// ─── DynamicService request/response messages ─────────────────────────────────

message InsertRequest {
  string     collection      = 1;
  bytes      bson_payload    = 2;  // BsonDocument serialized to raw BSON bytes
  string     transaction_id  = 3;  // optional — empty = auto-commit
}

message InsertResponse {
  BsonIdBytes id     = 1;
  string      error  = 2;
}

message UpdateRequest {
  string      collection      = 1;
  BsonIdBytes id              = 2;
  bytes       bson_payload    = 3;
  string      transaction_id  = 4;  // optional — empty = auto-commit
}

message DeleteRequest {
  string      collection      = 1;
  BsonIdBytes id              = 2;
  string      transaction_id  = 3;  // optional — empty = auto-commit
}

message MutationResponse {
  bool   success = 1;
  string error   = 2;
}

message FindByIdRequest {
  string      collection = 1;
  BsonIdBytes id         = 2;
}

message DocumentResponse {
  bytes  bson_payload = 1;  // raw BSON bytes; empty when not found
  bool   found        = 2;
  string error        = 3;
}

// QueryRequest is shared between DynamicService and DocumentService.
// query_descriptor is a MessagePack-encoded QueryDescriptor.
message QueryRequest {
  bytes query_descriptor = 1;
}

message BulkInsertRequest {
  string         collection      = 1;
  repeated bytes payloads        = 2;
  string         transaction_id  = 3;  // optional
}

message BulkInsertResponse {
  repeated BsonIdBytes ids   = 1;
  string               error = 2;
}

message BulkUpdateRequest {
  string                  collection      = 1;
  repeated BulkUpdateItem items           = 2;
  string                  transaction_id  = 3;  // optional
}

message BulkUpdateItem {
  BsonIdBytes id           = 1;
  bytes       bson_payload = 2;
}

message BulkDeleteRequest {
  string               collection      = 1;
  repeated BsonIdBytes ids             = 2;
  string               transaction_id  = 3;  // optional
}

message BulkMutationResponse {
  int32  affected_count = 1;
  string error          = 2;
}

message CollectionListResponse {
  repeated string names = 1;
}

message DropCollectionRequest {
  string collection = 1;
}

// ─── DocumentService request/response messages ────────────────────────────────

// TypedDocumentResponse carries projected bytes (the SELECT result, not full T).
message TypedDocumentResponse {
  bytes  bson_payload  = 1;
  string type_name     = 2;  // hint for client-side deserialization
  string error         = 3;
}

message TypedInsertRequest {
  string collection      = 1;
  bytes  bson_payload    = 2;  // T serialized via BLite mapper
  string type_name       = 3;
  string transaction_id  = 4;  // optional
}

message TypedUpdateRequest {
  string      collection      = 1;
  BsonIdBytes id              = 2;
  bytes       bson_payload    = 3;
  string      type_name       = 4;
  string      transaction_id  = 5;  // optional
}

message TypedBulkInsertRequest {
  string         collection      = 1;
  string         type_name       = 2;
  repeated bytes payloads        = 3;
  string         transaction_id  = 4;  // optional
}

// ─── MetadataService ──────────────────────────────────────────────────────────
// Key-map negotiation between client and server.
// The C-BSON format encodes field names as 2-byte ushort IDs whose mapping is
// stored persistently in the global StorageEngine dictionary.
// Clients MUST synchronise their local key map with the server before sending
// typed payloads, so that predicate push-down works correctly.

service MetadataService {
  // Ensures every field name in the request is registered in the global
  // dictionary, then returns the assigned ID for each requested key.
  // Use this before inserting typed documents so that the client's local map
  // matches the server's assignments exactly.
  // Requires Insert (Write) permission on the specified collection.
  rpc RegisterKeys (RegisterKeysRequest) returns (KeyMapResponse);

  // Returns the full global key→id map (all keys known to the server).
  // Useful on reconnect or when the client needs to refresh a stale cache.
  // Requires Query (Read) permission on the specified collection.
  rpc GetKeyMap    (KeyMapRequest)       returns (KeyMapResponse);
}

// ─── MetadataService messages ─────────────────────────────────────────────────

message KeyMapRequest {
  string collection = 1;  // permission check anchor — the collection the caller is working with
}

message RegisterKeysRequest {
  string          collection = 1;  // permission check anchor
  repeated string keys       = 2;  // field names to register (mapper.UsedKeys)
}

// Carries a subset (RegisterKeys) or the full (GetKeyMap) global dictionary.
// entries: field_name → ushort id (fits in uint32; values are always ≤ 65535).
message KeyMapResponse {
  map<string, uint32> entries = 1;
  string              error   = 2;
}

// ─── AdminService ─────────────────────────────────────────────────────────────
// User and permission management.  All RPCs require a caller with Admin permission.

service AdminService {
  rpc CreateUser   (CreateUserRequest)        returns (CreateUserResponse);
  rpc RevokeUser   (UsernameRequest)          returns (MutationResponse);
  rpc RotateKey    (UsernameRequest)          returns (RotateKeyResponse);
  rpc ListUsers    (Empty)                    returns (ListUsersResponse);
  rpc UpdatePerms  (UpdatePermsRequest)       returns (MutationResponse);
}

// ─── AdminService messages ────────────────────────────────────────────────────

message UserPermission {
  string collection = 1;  // "*" = wildcard
  int32  ops        = 2;  // BLiteOperation flags
}

message CreateUserRequest {
  string                  username    = 1;
  string                  namespace   = 2;  // empty = root namespace
  repeated UserPermission permissions = 3;
}

message CreateUserResponse {
  string api_key = 1;  // plaintext key — shown once, never stored
  string error   = 2;
}

message UsernameRequest {
  string username = 1;
}

message RotateKeyResponse {
  string api_key = 1;  // new plaintext key
  string error   = 2;
}

message UserInfo {
  string                  username    = 1;
  string                  namespace   = 2;
  bool                    active      = 3;
  string                  created_at  = 4;  // ISO-8601 UTC
  repeated UserPermission permissions = 5;
}

message ListUsersResponse {
  repeated UserInfo users = 1;
  string            error = 2;
}

message UpdatePermsRequest {
  string                  username    = 1;
  repeated UserPermission permissions = 2;
}

// ─── TransactionService ───────────────────────────────────────────────────────
// Explicit transaction control.  Begin acquires a server-side transaction;
// all write RPCs that carry the returned transaction_id participate in it.
// The transaction is automatically rolled back after the configured timeout
// (default 60 s, see Transactions:TimeoutSeconds in appsettings).

service TransactionService {
  rpc Begin    (BeginTransactionRequest)  returns (BeginTransactionResponse);
  rpc Commit   (TransactionRequest)       returns (MutationResponse);
  rpc Rollback (TransactionRequest)       returns (MutationResponse);
}

// ─── TransactionService messages ─────────────────────────────────────────────

message BeginTransactionRequest {}

message BeginTransactionResponse {
  string transaction_id = 1;  // UUID — pass in subsequent write requests
  string error          = 2;
}

message TransactionRequest {
  string transaction_id = 1;
}
